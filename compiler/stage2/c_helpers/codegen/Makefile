# MELP Stage 2 - Code Generator Makefile
# Generated by: YZ_05 (Code Generation Specialist)
# Date: 15 Ocak 2026
# Phase: 5.0 - Code Generation Implementation
#
# This Makefile builds and tests the LLVM IR code generator.
#
# Usage:
#   make           - Build test executable
#   make test      - Run test suite
#   make clean     - Remove build artifacts

CC = gcc
CFLAGS = -Wall -Wextra -Werror -std=c11 -g
BUILD_DIR = build

# Include paths (peer architecture)
INC = -I../common -I../lexer -I../parser -I../semantic

# Source directories
COMMON_SRC = ../common
LEXER_SRC = ../lexer
PARSER_SRC = ../parser
SEMANTIC_SRC = ../semantic
CODEGEN_SRC = .

# Object files
COMMON_OBJS = $(BUILD_DIR)/token.o $(BUILD_DIR)/ast.o
LEXER_OBJS = $(BUILD_DIR)/lexer_impl.o
PARSER_OBJS = $(BUILD_DIR)/parser_impl.o
SEMANTIC_OBJS = $(BUILD_DIR)/symbol_table.o $(BUILD_DIR)/type_checker.o $(BUILD_DIR)/semantic_analyzer.o
CODEGEN_OBJS = $(BUILD_DIR)/codegen.o
TEST_OBJS = $(BUILD_DIR)/test_codegen.o

ALL_OBJS = $(COMMON_OBJS) $(LEXER_OBJS) $(PARSER_OBJS) $(SEMANTIC_OBJS) $(CODEGEN_OBJS)

# Test executable
TEST_EXE = $(BUILD_DIR)/test_codegen

# ============================================================================
# PHONY TARGETS
# ============================================================================

.PHONY: all test clean directories

all: directories $(TEST_EXE)

test: $(TEST_EXE)
	@echo "========================================"
	@echo "Running Code Generator Test Suite..."
	@echo "========================================"
	./$(TEST_EXE)

clean:
	rm -rf $(BUILD_DIR)
	rm -f /tmp/test_*.ll /tmp/test_*.s /tmp/test_*

directories:
	@mkdir -p $(BUILD_DIR)

# ============================================================================
# BUILD RULES
# ============================================================================

# Test executable
$(TEST_EXE): $(ALL_OBJS) $(TEST_OBJS)
	$(CC) $(CFLAGS) -o $@ $^

# Common module objects
$(BUILD_DIR)/token.o: $(COMMON_SRC)/token.c $(COMMON_SRC)/token.h
	$(CC) $(CFLAGS) $(INC) -c $< -o $@

$(BUILD_DIR)/ast.o: $(COMMON_SRC)/ast.c $(COMMON_SRC)/ast.h
	$(CC) $(CFLAGS) $(INC) -c $< -o $@

# Lexer module objects
$(BUILD_DIR)/lexer_impl.o: $(LEXER_SRC)/lexer_impl.c $(LEXER_SRC)/lexer_impl.h
	$(CC) $(CFLAGS) $(INC) -c $< -o $@

# Parser module objects
$(BUILD_DIR)/parser_impl.o: $(PARSER_SRC)/parser_impl.c $(PARSER_SRC)/parser_impl.h
	$(CC) $(CFLAGS) $(INC) -c $< -o $@

# Semantic module objects
$(BUILD_DIR)/symbol_table.o: $(SEMANTIC_SRC)/symbol_table.c $(SEMANTIC_SRC)/symbol_table.h
	$(CC) $(CFLAGS) $(INC) -c $< -o $@

$(BUILD_DIR)/type_checker.o: $(SEMANTIC_SRC)/type_checker.c $(SEMANTIC_SRC)/type_checker.h
	$(CC) $(CFLAGS) $(INC) -c $< -o $@

$(BUILD_DIR)/semantic_analyzer.o: $(SEMANTIC_SRC)/semantic_analyzer.c $(SEMANTIC_SRC)/semantic_analyzer.h
	$(CC) $(CFLAGS) $(INC) -c $< -o $@

# Codegen module objects
$(BUILD_DIR)/codegen.o: $(CODEGEN_SRC)/codegen.c $(CODEGEN_SRC)/codegen.h
	$(CC) $(CFLAGS) $(INC) -c $< -o $@

# Test objects
$(BUILD_DIR)/test_codegen.o: $(CODEGEN_SRC)/test_codegen.c $(CODEGEN_SRC)/codegen.h
	$(CC) $(CFLAGS) $(INC) -c $< -o $@

# ============================================================================
# HELP
# ============================================================================

help:
	@echo "MELP Stage 2 - Code Generator Makefile"
	@echo ""
	@echo "Targets:"
	@echo "  make           - Build test executable"
	@echo "  make test      - Run test suite (>25 tests)"
	@echo "  make clean     - Remove build artifacts"
	@echo "  make help      - Show this help message"
	@echo ""
	@echo "Architecture:"
	@echo "  - Peer to semantic analyzer"
	@echo "  - LLVM IR text-based code generation"
	@echo "  - 31 comprehensive test cases"
	@echo ""
