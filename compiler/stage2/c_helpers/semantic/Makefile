# MELP Stage 2 - Semantic Analyzer Makefile
# Generated by: YZ_04 (Semantic Analysis Specialist)
# Date: 15 Ocak 2026
# Phase: 4.0 - Semantic Analysis Implementation

CC = gcc
CFLAGS = -Wall -Wextra -Werror -std=c11 -g
BUILD_DIR = build

# Include paths (peer architecture)
INC = -I../common -I../lexer -I../parser

# Source directories
COMMON_DIR = ../common
LEXER_DIR = ../lexer
PARSER_DIR = ../parser
SEMANTIC_DIR = .

# Object files (dependencies from other phases)
OBJS = $(BUILD_DIR)/token.o \
       $(BUILD_DIR)/lexer_impl.o \
       $(BUILD_DIR)/ast.o \
       $(BUILD_DIR)/parser_impl.o \
       $(BUILD_DIR)/symbol_table.o \
       $(BUILD_DIR)/type_checker.o \
       $(BUILD_DIR)/semantic_analyzer.o

# Test executable
TEST_EXEC = $(BUILD_DIR)/test_semantic

# ============================================================================
# MAIN TARGETS
# ============================================================================

.PHONY: all test clean

all: $(TEST_EXEC)

test: $(TEST_EXEC)
	@echo "========================================"
	@echo "Running semantic analyzer tests..."
	@echo "========================================"
	./$(TEST_EXEC)

clean:
	rm -rf $(BUILD_DIR)

# ============================================================================
# BUILD RULES
# ============================================================================

# Create build directory
$(BUILD_DIR):
	mkdir -p $(BUILD_DIR)

# Test executable
$(TEST_EXEC): $(OBJS) $(BUILD_DIR)/test_semantic.o | $(BUILD_DIR)
	$(CC) $(CFLAGS) -o $@ $^

# Common objects
$(BUILD_DIR)/token.o: $(COMMON_DIR)/token.h | $(BUILD_DIR)
	@echo "Note: token.h is header-only, creating empty object"
	@touch $@

$(BUILD_DIR)/ast.o: $(COMMON_DIR)/ast.c $(COMMON_DIR)/ast.h $(COMMON_DIR)/token.h | $(BUILD_DIR)
	$(CC) $(CFLAGS) $(INC) -c $< -o $@

# Lexer objects
$(BUILD_DIR)/lexer_impl.o: $(LEXER_DIR)/lexer_impl.c $(LEXER_DIR)/lexer_impl.h $(COMMON_DIR)/token.h | $(BUILD_DIR)
	$(CC) $(CFLAGS) $(INC) -c $< -o $@

# Parser objects
$(BUILD_DIR)/parser_impl.o: $(PARSER_DIR)/parser_impl.c $(PARSER_DIR)/parser_impl.h $(COMMON_DIR)/ast.h $(LEXER_DIR)/lexer_impl.h | $(BUILD_DIR)
	$(CC) $(CFLAGS) $(INC) -c $< -o $@

# Semantic objects
$(BUILD_DIR)/symbol_table.o: $(SEMANTIC_DIR)/symbol_table.c $(SEMANTIC_DIR)/symbol_table.h $(COMMON_DIR)/ast.h | $(BUILD_DIR)
	$(CC) $(CFLAGS) $(INC) -c $< -o $@

$(BUILD_DIR)/type_checker.o: $(SEMANTIC_DIR)/type_checker.c $(SEMANTIC_DIR)/type_checker.h $(SEMANTIC_DIR)/symbol_table.h | $(BUILD_DIR)
	$(CC) $(CFLAGS) $(INC) -c $< -o $@

$(BUILD_DIR)/semantic_analyzer.o: $(SEMANTIC_DIR)/semantic_analyzer.c $(SEMANTIC_DIR)/semantic_analyzer.h $(SEMANTIC_DIR)/symbol_table.h $(SEMANTIC_DIR)/type_checker.h | $(BUILD_DIR)
	$(CC) $(CFLAGS) $(INC) -c $< -o $@

# Test objects
$(BUILD_DIR)/test_semantic.o: $(SEMANTIC_DIR)/test_semantic.c $(SEMANTIC_DIR)/semantic_analyzer.h | $(BUILD_DIR)
	$(CC) $(CFLAGS) $(INC) -c $< -o $@

# ============================================================================
# HELPER TARGETS
# ============================================================================

.PHONY: help

help:
	@echo "MELP Stage 2 - Semantic Analyzer Makefile"
	@echo ""
	@echo "Targets:"
	@echo "  make         - Build test executable"
	@echo "  make test    - Build and run tests"
	@echo "  make clean   - Remove build artifacts"
	@echo "  make help    - Show this help message"
	@echo ""
	@echo "Requirements:"
	@echo "  - GCC with C11 support"
	@echo "  - Common, lexer, and parser modules must be built"
