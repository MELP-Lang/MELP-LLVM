# MELP Stage 2 - Parser Build System
# Generated by: YZ_03 (Parser Specialist)
# Date: 16 Ocak 2026
# Phase: 3.0 - Parser Implementation (Task 3.5)

# Compiler settings
CC = gcc
CFLAGS = -Wall -Wextra -Werror -std=c11 -g -O0
INCLUDES = -I../common -I../lexer

# Directories
SRC_DIR = .
COMMON_DIR = ../common
LEXER_DIR = ../lexer
BUILD_DIR = build

# Source files
PARSER_SRC = $(SRC_DIR)/parser_impl.c
AST_SRC = $(COMMON_DIR)/ast.c
LEXER_SRC = $(LEXER_DIR)/lexer_impl.c
TEST_SRC = $(SRC_DIR)/test_parser.c

# Object files
PARSER_OBJ = $(BUILD_DIR)/parser_impl.o
AST_OBJ = $(BUILD_DIR)/ast.o
LEXER_OBJ = $(BUILD_DIR)/lexer_impl.o
TEST_OBJ = $(BUILD_DIR)/test_parser.o

# Output binaries
TEST_BIN = $(BUILD_DIR)/test_parser

# Default target: build and run tests
.PHONY: all
all: test

# Create build directory
$(BUILD_DIR):
	mkdir -p $(BUILD_DIR)

# Compile AST implementation
$(AST_OBJ): $(AST_SRC) $(COMMON_DIR)/ast.h $(COMMON_DIR)/token.h | $(BUILD_DIR)
	$(CC) $(CFLAGS) $(INCLUDES) -c $(AST_SRC) -o $(AST_OBJ)

# Compile lexer implementation (dependency)
$(LEXER_OBJ): $(LEXER_SRC) $(LEXER_DIR)/lexer_impl.h $(COMMON_DIR)/token.h | $(BUILD_DIR)
	$(CC) $(CFLAGS) $(INCLUDES) -c $(LEXER_SRC) -o $(LEXER_OBJ)

# Compile parser implementation
$(PARSER_OBJ): $(PARSER_SRC) $(SRC_DIR)/parser_impl.h $(COMMON_DIR)/ast.h $(LEXER_DIR)/lexer_impl.h | $(BUILD_DIR)
	$(CC) $(CFLAGS) $(INCLUDES) -c $(PARSER_SRC) -o $(PARSER_OBJ)

# Compile test suite
$(TEST_OBJ): $(TEST_SRC) $(SRC_DIR)/parser_impl.h $(COMMON_DIR)/ast.h | $(BUILD_DIR)
	$(CC) $(CFLAGS) $(INCLUDES) -c $(TEST_SRC) -o $(TEST_OBJ)

# Link test binary
$(TEST_BIN): $(PARSER_OBJ) $(AST_OBJ) $(LEXER_OBJ) $(TEST_OBJ)
	$(CC) $(CFLAGS) $(PARSER_OBJ) $(AST_OBJ) $(LEXER_OBJ) $(TEST_OBJ) -o $(TEST_BIN)

# Build tests
.PHONY: build
build: $(TEST_BIN)

# Run tests
.PHONY: test
test: $(TEST_BIN)
	@echo "═══════════════════════════════════════════════════════════"
	@echo "Running Parser Unit Tests..."
	@echo "═══════════════════════════════════════════════════════════"
	@$(TEST_BIN)

# Run tests with valgrind (memory leak check)
.PHONY: memcheck
memcheck: $(TEST_BIN)
	@echo "═══════════════════════════════════════════════════════════"
	@echo "Running Valgrind Memory Check..."
	@echo "═══════════════════════════════════════════════════════════"
	valgrind --leak-check=full --show-leak-kinds=all --track-origins=yes \
		--verbose --error-exitcode=1 $(TEST_BIN)

# Clean build artifacts
.PHONY: clean
clean:
	rm -rf $(BUILD_DIR)

# Help target
.PHONY: help
help:
	@echo "MELP Stage 2 - Parser Build System"
	@echo ""
	@echo "Available targets:"
	@echo "  make all       - Build and run tests (default)"
	@echo "  make build     - Build test binary only"
	@echo "  make test      - Run unit tests"
	@echo "  make memcheck  - Run tests with valgrind"
	@echo "  make clean     - Remove build artifacts"
	@echo "  make help      - Show this help message"
	@echo ""
	@echo "Test Results:"
	@echo "  Exit code 0 = All tests passed"
	@echo "  Exit code 1 = Some tests failed"
